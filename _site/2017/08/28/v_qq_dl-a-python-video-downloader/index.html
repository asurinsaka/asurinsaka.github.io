<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      v_qq_dl a small video downloader &middot; Asurin
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Asurin <br /> System Engineer <br /> Web Developer <br /></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About Me</a>
        
      
    
      
    
      
        
      
    


  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2017. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Asurin</a>
            <small>System Engineer, Data Scientist, Web Developer</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">v_qq_dl a small video downloader</h1>
  <span class="post-date">28 Aug 2017</span>
  <p>There is a Chinese video hosting website v.qq.com from Tencent company has many
interesting tv shows. The servers are in China so it would be slow to watch
in web browser. And I usually watch my TV with Nexus Player, which dose not have
a program to watch online video directly from v.qq.com.</p>

<p>Before I started to program my own downloader, I searched github for existing
downloader. There is one called <a href="https://rg3.github.io/youtube-dl/">youtube-dl</a>,
which while this article was written, dose not support v.qq.com.</p>

<p>The other one <a href="https://github.com/soimort/you-get">you-get</a> supports v.qq.com.
However, it only download at 2KB/s while downloading directly.</p>

<p>So I started to program my own downloader and use proxy and multiple threaded
downloading to increase the speed. The downloader can also resume from broken
downloads.</p>

<h1 id="1-http-partial-requests">1. HTTP partial requests</h1>

<p>HTTP range requests allow to send only a portion of an HTTP message from a server
to a client. This is very useful for resuming downloads.</p>

<p>We can check whether the server sports partial by checking “Accept-Ranges” in the
header of the HTTP response. This is not implemented in my program right now.</p>

<h1 id="2-using-python-to-download-the-file">2. Using Python to download the file</h1>

<p>There is a very easy to use python HTTP package called <a href="http://docs.python-requests.org/en/master/">requests</a> can be used to
download files from internet. A sample download code is here:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">local_filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c"># NOTE the stream=True parameter</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_filename</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span> <span class="c"># filter out keep-alive new chunks</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">local_filename</span></code></pre></figure>

<p>This part is the core code for downloading. However, we need to wrap the code
with multithreading and also need to monitor the progress to support resuming.</p>

<h1 id="3-python-multithreading">3. Python multithreading</h1>

<p>We can use either multithreading or multiprocessing to increase the download
speed. To monitor the download progress, data has to be shared between instance.
Which would be easier to be implemented in multithreading program. Recall that
different thread are using the same data.</p>

<p>In this program, I am using <a href="https://pypi.python.org/pypi/pathos">pathos</a> package
for the multithreading for 2 reasons.</p>
<ol>
  <li>It can use Pool for threads to limit the number of threads</li>
  <li>It use dill, which can serialize file pointer to be passed in arguments</li>
</ol>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">thread_count</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fps</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># Each thread is responsible for one block of the one media file, this for loop pack</span>
<span class="c"># the arguments in the args list</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">info_file</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">info_files</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">continue</span>

    <span class="n">workname</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">'.download'</span>

    <span class="c"># each block has 3 parts, the start of the block, the offset, the end of the block</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">info_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">info_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_x</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">info_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">block_count</span><span class="p">,</span> <span class="n">remain</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)</span>

        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block_count</span><span class="p">)]</span>
        <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">remain</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">workname</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">''</span><span class="p">)</span>

    <span class="n">file_info</span> <span class="o">=</span> <span class="n">FileInfo</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_monitor</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">file_info</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">info_file</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">workname</span><span class="p">,</span> <span class="s">'rb+'</span><span class="p">)</span>
    <span class="n">fps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">new_args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">url</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fp</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span> <span class="k">if</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">new_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_args</span><span class="p">)</span>

<span class="k">if</span> <span class="n">thread_count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">thread_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="k">if</span> <span class="n">thread_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c"># Use a progress bar to show the downloading the progress</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_progress_bar</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">sizes</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">thread_count</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">_worker</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></code></pre></figure>

<h1 id="4-tracking-progress">4. Tracking progress</h1>

<p>To be able to resume broken downloads, the program has to have the ability to
track and record downloading progress for each file. In this program, we divided
the media file into blocks and use an info file to track each block. To resuming the download, exam the info file and only download the unfinished blocks by specify range header for the HTTP requests. The core download code and the monitor code is:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_worker</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Range'</span><span class="p">:</span> <span class="s">'bytes=</span><span class="si">%</span><span class="s">s-</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">block</span><span class="p">[</span><span class="mi">2</span><span class="p">])}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="c"># TODO :requests.exceptions.ChunkedEncodingError: ("Connection broken: ConnectionResetError(54, 'Connection reset by peer')", ConnectionResetError(54, 'Connection reset by peer'))</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'</span><span class="err">\</span><span class="s">_worker: {} {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">headers</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="n">file_info</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">info_file</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">percent</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">write_data</span><span class="p">(</span><span class="n">info_file</span><span class="p">,</span> <span class="p">(</span><span class="n">file_info</span><span class="p">,</span> <span class="n">blocks</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'_monitor: {} {} {}percent {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="n">blocks</span><span class="p">))</span></code></pre></figure>

<p>The source code of the project is <a href="https://github.com/asurinsaka/v_qq_dl">here</a>:</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/08/09/Shinyapp/">
            Shinyapp
            <small>09 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/08/05/Some-IDL-examples/">
            Some IDL examples
            <small>05 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/08/05/IPOPP-modis-flowchart/">
            IMaRS IPOPP modis Data Flowchart
            <small>05 Aug 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
