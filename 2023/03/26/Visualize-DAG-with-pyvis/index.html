<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Visualize DAG with pyvis &middot; Asurin
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
    
  <!-- Lightbox -->
  <script src="/public/js/jquery.min.js"></script>
  <style>
.lightbox {width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.85); z-index: 9999999; line-height: 0; cursor: pointer;}
.lightbox .img {
	position: relative;
	top: 50%;
	left: 50%;
	-ms-transform: translateX(-50%) translateY(-50%);
	-webkit-transform: translate(-50%,-50%);
	transform: translate(-50%,-50%);
	max-width: 100%;
	max-height: 100%;
}
.lightbox .img img {opacity: 0; pointer-events: none; width: auto;}
@media screen and (min-width: 1200px) {
    .lightbox .img {
		max-width: 1200px;
    }
}
@media screen and (min-height: 1200px) {
    .lightbox img {
		max-height: 1200px;
	}
}
.lightbox span {
		display: block;
		position: fixed;
		bottom: 13px;
		height: 1.5em;
		line-height: 1.4em;
		width: 100%;
		text-align: center;
		color: white;
		text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;
}






.lightbox .videoWrapperContainer {
	position: relative;
	top: 50%;
	left: 50%;
	-ms-transform: translateX(-50%) translateY(-50%);
	-webkit-transform: translate(-50%,-50%);
	transform: translate(-50%,-50%);
	max-width: 900px;
	max-height: 100%;
}
.lightbox .videoWrapperContainer .videoWrapper {
	height: 0;
	line-height: 0;
	margin: 0;
	padding: 0;
	position: relative;
	padding-bottom: 56.333%; /* custom */
	background: black;
}
.lightbox .videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	border: 0;
	display: block;
}
.lightbox #prev, .lightbox #next {height: 50px; line-height: 36px; display: none; margin-top: -25px; position: fixed; top: 50%; padding: 0 15px; cursor: pointer; text-decoration: none; z-index: 99; color: white; font-size: 60px;}
.lightbox.gallery #prev, .lightbox.gallery #next {display: block;}
.lightbox #prev {left: 0;}
.lightbox #next {right: 0;}
.lightbox #close {height: 50px; width: 50px; position: fixed; cursor: pointer; text-decoration: none; z-index: 99; right: 0; top: 0;}
.lightbox #close:after, .lightbox #close:before {position: absolute; margin-top: 22px; margin-left: 14px; content: ""; height: 3px; background: white; width: 23px;
-webkit-transform-origin: 50% 50%;
-moz-transform-origin: 50% 50%;
-o-transform-origin: 50% 50%;
transform-origin: 50% 50%;
/* Safari */
-webkit-transform: rotate(-45deg);
/* Firefox */
-moz-transform: rotate(-45deg);
/* IE */
-ms-transform: rotate(-45deg);
/* Opera */
-o-transform: rotate(-45deg);
}
.lightbox #close:after {
/* Safari */
-webkit-transform: rotate(45deg);
/* Firefox */
-moz-transform: rotate(45deg);
/* IE */
-ms-transform: rotate(45deg);
/* Opera */
-o-transform: rotate(45deg);
}
.lightbox, .lightbox * {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Opera and Firefox */}
}
</style>

<script>
function is_youtubelink(url) {
  var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
  return (url.match(p)) ? RegExp.$1 : false;
}
function is_imagelink(url) {
	var p = /([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/i;
	return (url.match(p)) ? true : false;
}
function is_vimeolink(url,el) {
	var id = false;
	$.ajax({
	  url: 'https://vimeo.com/api/oembed.json?url='+url,
	  async: true,
	  success: function(response) {
		if(response.video_id) {
		  id = response.video_id;
		  $(el).addClass('lightbox-vimeo').attr('data-id',id);
		}
	  }
	});
}

$(document).ready(function() {
	//add classes to links to be able to initiate lightboxes
	$("a").each(function(){
		var url = $(this).attr('href');
		if(url) {
			if(url.indexOf('vimeo') !== -1 && !$(this).hasClass('no-lightbox')) is_vimeolink(url,$(this));
			if(is_youtubelink(url) && !$(this).hasClass('no-lightbox')) $(this).addClass('lightbox-youtube').attr('data-id',is_youtubelink(url));
			if(is_imagelink(url) && !$(this).hasClass('no-lightbox')) {
				$(this).addClass('lightbox-image');
				var href = $(this).attr('href');
				var filename = href.split('/').pop();
				var split = filename.split(".");
				var name = split[0];
				$(this).attr('title',name);
			}
		}
	});
	//remove the clicked lightbox
	$("body").on("click", ".lightbox", function(event){
		if($(this).hasClass('gallery')) {

			$(this).remove();

			if($(event.target).attr('id')=='next') {
				//next item
				if($("a.gallery.current").nextAll("a.gallery:first").length) $("a.gallery.current").nextAll("a.gallery:first").click();
				else $("a.gallery.current").parent().find("a.gallery").first().click();
			}
			else if ($(event.target).attr('id')=='prev') {
				//prev item
				if($("a.gallery.current").prevAll("a.gallery:first").length) $("a.gallery.current").prevAll("a.gallery:first").click();
				else $("a.gallery.current").parent().find("a.gallery").last().click();
			}
			else {
				$("a.gallery").removeClass('gallery');
			}
		}
		else $(this).remove();
	});
	//prevent image from being draggable (for swipe)
	$("body").on('dragstart', ".lightbox img", function(event) { event.preventDefault(); });
	//add the youtube lightbox on click
	$("a.lightbox-youtube").click(function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="videoWrapperContainer"><div class="videoWrapper"><iframe src="https://www.youtube.com/embed/'+$(this).attr('data-id')+'?autoplay=1&showinfo=0&rel=0"></iframe></div></div></div>').appendTo('body');
	});
	//add the image lightbox on click
	$("a.lightbox-image").click(function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="img" style="background: url(\''+$(this).attr('href')+'\') center center / contain no-repeat;" title="'+$(this).attr('title')+'" ><img src="'+$(this).attr('href')+'" alt="'+$(this).attr('title')+'" /></div><span>'+$(this).attr('title')+'</span></div>').appendTo('body');
	});
	//add the vimeo lightbox on click
	$("body").on("click", "a.lightbox-vimeo", function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="videoWrapperContainer"><div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+$(this).attr('data-id')+'/?autoplay=1&byline=0&title=0&portrait=0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div></div></div>').appendTo('body');
	});

	$("body").on("click", "a[class*='lightbox-']", function(){
		var link_elements = $(this).parent().find("a[class*='lightbox-']");
		$(link_elements).removeClass('current');
		for (var i=0; i<link_elements.length; i++) {
			if($(this).attr('href') == $(link_elements[i]).attr('href')) {
				$(link_elements[i]).addClass('current');
			}
		}
		if(link_elements.length>1) {
			$('.lightbox').addClass('gallery');
			$(link_elements).addClass('gallery');
		}
	});


});

$(document).keydown(function(e) {
    switch(e.which) {
        case 37: // left
        $("#prev").click();
        break;
        case 39: // right
        $("#next").click();
        break;
	case 27: // esc
        $("#close").click();
        break;
        default: return; // exit this handler for other keys
    }
    e.preventDefault(); // prevent the default action (scroll / move caret)
});



  /*===========================
  Swipe-it v1.4.1
  An event listener for swiping gestures with vanilla js.
  https://github.com/tri613/swipe-it#readme

  @Create 2016/09/22
  @Update 2017/08/11
  @Author Trina Lu
  ===========================*/

  "use strict";var _slicedToArray=function(){function n(n,t){var e=[],i=!0,o=!1,r=void 0;try{for(var u,c=n[Symbol.iterator]();!(i=(u=c.next()).done)&&(e.push(u.value),!t||e.length!==t);i=!0);}catch(n){o=!0,r=n}finally{try{!i&&c.return&&c.return()}finally{if(o)throw r}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(n,t,e){function i(n){function e(){o("touchstart",m,w),o("touchmove",d,w),o("touchend",p,w),E.mouseEvent&&o("mousedown",s,w)}function i(){y=!1,D=!1,A=!1,b=!1,a=!1}function s(n){a=this,y=n.clientX,D=n.clientY,o("mousemove",l,v),o("mouseup",h,v)}function l(n){n.preventDefault(),y&&D&&(A=n.clientX,b=n.clientY)}function h(n){r("mousemove",l,v),r("mouseup",h,v),p(n)}function m(n){a=this,y=n.touches[0].clientX,D=n.touches[0].clientY}function d(n){A=n.touches[0].clientX,b=n.touches[0].clientY}function p(n){if(y&&D&&A&&b){var t=y-A,e=D-b,o=[t,e].map(Math.abs),r=_slicedToArray(o,2),c=r[0],s=r[1],v=E.minDistance;if(c>v){var f=y<A?"swipeRight":"swipeLeft";u(f,a,{distance:t,start:y,end:A})}if(s>v){var l=D>b?"swipeUp":"swipeDown";u(l,a,{distance:e,start:D,end:b})}(c>v||s>v)&&u("swipe",a)}i()}var E=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},w=c(t.querySelectorAll(n)),y=void 0,D=void 0,A=void 0,b=void 0;E.mouseEvent=void 0===E.mouseEvent?f.mouseEvent:E.mouseEvent,E.minDistance=void 0===E.minDistance?f.minDistance:E.minDistance,i(),e(),this.on=function(n,t){return o(n,t,w),this}}function o(n,t,e){s(e).forEach(function(e){return e.addEventListener(n,t)})}function r(n,t,e){s(e).forEach(function(e){return e.removeEventListener(n,t)})}function u(n,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=t.createEvent("Event");o.initEvent(n,!0,!0),o.swipe=i,s(e).forEach(function(n){return n.dispatchEvent(o)})}function c(n){for(var t=[],e=0;e<n.length;e++)t.push(n[e]);return t}function s(n){return Array.isArray(n)?n:[n]}var a=!1,v=[n],f={mouseEvent:!0,minDistance:30};n[e]=i}(window,document,"SwipeIt");

var mySwipeIt = new SwipeIt('body');
mySwipeIt.on('swipeLeft',function(e){
	//check if lightbox is present
	if($('.lightbox').length >  0 ) {
		$("#next").click();
	}
}).on('swipeRight',function(e){
	//check if lightbox is present
	if($('.lightbox').length >  0 ) {
		$("#prev").click();
	}
});

</script>

</head>


  <body class="theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Asurin <br /> Software Developer <br /></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About Me</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/niuniu/">Niu Niu</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    


  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Asurin</a>
            <small>Software Developer</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Visualize DAG with pyvis</h1>
  <span class="post-date">26 Mar 2023</span>
  <p>In previous post <a href="/2023/03/25/visualize-DAG-with-graphviz/">Visualize DAG with Graphviz</a>, I talked about how to use Graphviz to display DAG. Graphviz is greate but it can only generate pictures in svg. For nodes with large amount of data, it will be hard to show all the data in a single picture.</p>

<p>With today’s javascript, it will be nice to show and hide node infomation dynamically. Rowland has created a internal repo called gexplorer, which runs on a flask server with vis.js on the front end. The problem with this implementation is that it is hard to share the data. The other people has to have access to your server, or have to spin up his own server. Or he can only receive screenshot of the picture. I think it would be nice if we have this kinda of dynamic implementation with jupyterlab.</p>

<p>Last Friday(03/24/2023), a colleage Tzintzuni Garcia from bio team of GDC, did a presentation about his attempt. He used <a href="https://docs.bokeh.org/en/latest/">bokeh</a> to build the visulaizaiton. Network is shown in the example pictures of bokeh but I could not find good tutorial about how to build network with bokeh on its offical website. I think network is not one of their main focus. And in the presentation, the library is not hendling hierarchy for DAG very well.</p>

<p>Recently I found a python library called <a href="https://pyvis.readthedocs.io/en/latest/">pyvis</a>. Which also use <a href="https://visjs.org/">vis.js</a>. vis.js is a <!--break--></p>

<blockquote>
  <p>A dynamic, browser based visualization library.
The library is designed to be easy to use, to handle large amounts of dynamic data, and to enable manipulation of and interaction with the data.
The library consists of the components DataSet, Timeline, Network, Graph2d and Graph3d.</p>
</blockquote>

<p>It has rich implementation for <a href="https://visjs.github.io/vis-network/examples/">networks</a>. Pyvis is mainly the python wrapper for the network part of vis.js.</p>

<h1 id="examples-from-yaml-file">Examples from yaml file</h1>

<h2 id="examples">Examples</h2>
<p>The examples from previous psot <a href="/2023/03/25/visualize-DAG-with-graphviz/">Visualize DAG with Graphviz</a> will look like the following:</p>

<p><img src="/images/pyvis_gdc/gdc_dev_1585_vis.png" alt="1585_vis" /></p>

<p>The gdc samples from the previous post will look like:</p>

<p><img src="/images/pyvis_gdc/gdc_samples_vis.png" alt="gdc_samples" /></p>

<h2 id="code">Code</h2>

<p>Here is the code for this visualization with pyvis:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">yaml</span>
<span class="kn">from</span> <span class="n">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>

<span class="kn">from</span> <span class="n">pyvis.network</span> <span class="kn">import</span> <span class="n">Network</span>

<span class="kn">from</span> <span class="n">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">edges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    
    <span class="n">got_net</span> <span class="o">=</span> <span class="nc">Network</span><span class="p">(</span>
        <span class="n">notebook</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
        <span class="n">cdn_resources</span><span class="o">=</span><span class="s">'in_line'</span><span class="p">,</span> 
        <span class="n">layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
        <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
        <span class="n">height</span><span class="o">=</span><span class="s">'1111px'</span><span class="p">,</span> 
        <span class="n">width</span><span class="o">=</span><span class="s">'90%'</span>
    <span class="p">)</span>

    <span class="n">node_id_to_submitter_id</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">submitter_id</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"submitter_id"</span><span class="p">)</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"node_id"</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"：</span><span class="si">{</span><span class="n">node</span><span class="p">[</span><span class="s">'gencode_version'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"gencode_version"</span><span class="p">)</span> <span class="k">else</span> <span class="s">''</span>

        <span class="k">if</span> <span class="n">submitter_id</span> <span class="ow">and</span> <span class="n">node_id</span><span class="p">:</span>
            <span class="n">node_id_to_submitter_id</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">submitter_id</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">elif</span> <span class="n">submitter_id</span><span class="p">:</span>
            <span class="n">node_id_to_submitter_id</span><span class="p">[</span><span class="n">submitter_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">submitter_id</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_id_to_submitter_id</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_id</span> <span class="o">+</span> <span class="n">suffix</span>

    <span class="nf">print</span><span class="p">(</span><span class="n">node_id_to_submitter_id</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">n_id</span> <span class="o">=</span> <span class="n">node_id_to_submitter_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"node_id"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"submitter_id"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># print(n_id, node.get("submitter_id"), node.get("node_id"))
</span>        <span class="n">got_net</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span>
            <span class="n">n_id</span><span class="p">,</span> 
            <span class="n">n_id</span><span class="p">,</span> 
            <span class="n">title</span><span class="o">=</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="nf">items</span><span class="p">()),</span> 
            <span class="n">color</span><span class="o">=</span><span class="nf">get_color</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">'label'</span><span class="p">))</span>
        <span class="p">)</span>
        

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span> 
        <span class="n">src</span> <span class="o">=</span> <span class="n">node_id_to_submitter_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="s">"src"</span><span class="p">])</span> <span class="ow">or</span> <span class="n">edge</span><span class="p">[</span><span class="s">"src"</span><span class="p">]</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">node_id_to_submitter_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="s">"dst"</span><span class="p">])</span> <span class="ow">or</span> <span class="n">edge</span><span class="p">[</span><span class="s">"dst"</span><span class="p">]</span>
        <span class="c1"># print(src, dst, edge['src'], edge['dst'])
</span>        <span class="k">try</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">got_net</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">got_net</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">AssertionError</span><span class="p">:</span>
            <span class="k">continue</span>
    
    <span class="n">neighbor_map</span> <span class="o">=</span> <span class="n">got_net</span><span class="p">.</span><span class="nf">get_adj_list</span><span class="p">()</span>
    
    <span class="n">got_net</span><span class="p">.</span><span class="nf">show_buttons</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">got_net</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="nf">to_json</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s">"hubsize"</span><span class="p">,</span> <span class="s">"directed"</span><span class="p">)</span>
    <span class="n">got_net</span><span class="p">.</span><span class="nf">set_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">got_net</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="s">"graph.html"</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">display</span><span class="p">(</span><span class="nc">HTML</span><span class="p">(</span><span class="s">"graph.html"</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">draw_yaml</span><span class="p">(</span><span class="n">yaml_raw</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">yaml_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">yaml_raw</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="p">.</span><span class="n">FullLoader</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">yaml</span><span class="p">.</span><span class="n">scanner</span><span class="p">.</span><span class="n">ScannerError</span><span class="p">:</span>
        <span class="n">yaml_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">yaml_raw</span><span class="p">)</span>

    <span class="k">return</span> <span class="nf">draw</span><span class="p">(</span><span class="n">yaml_dict</span><span class="p">[</span><span class="s">'nodes'</span><span class="p">],</span> <span class="n">yaml_dict</span><span class="p">[</span><span class="s">'edges'</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">draw_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">draw_yaml</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>



<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid5</span><span class="p">(</span><span class="n">UUID_NAMESPACE</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
    <span class="n">label_color</span> <span class="o">=</span> <span class="nf">hex</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nf">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">label</span><span class="p">))))</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"#{:f&lt;6}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">label_color</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>


<span class="n">UUID_NAMESPACE_SEED</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="s">"UUID_NAMESPACE_SEED"</span><span class="p">,</span> <span class="s">"f0d2633b-cd8b-45ca-ae86-1d5c759ba0d1"</span><span class="p">)</span>
<span class="n">UUID_NAMESPACE</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">.</span><span class="nc">UUID</span><span class="p">(</span><span class="s">"urn:uuid:{}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">UUID_NAMESPACE_SEED</span><span class="p">),</span> <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code></pre></figure>

<p>A few things to metion about this code.</p>

<ol>
  <li>As you might notice, I used the same color algorithm written by Rowland.</li>
  <li><code class="language-plaintext highlighter-rouge">layout=True, directed=True</code> are needed for a good hierarchical layout. Those are not set by default.</li>
  <li><code class="language-plaintext highlighter-rouge">display(HTML("graph.html"))</code> is needed for google colab to display the chart. It is not neccessary if you are using jupyterlab etc.</li>
  <li><code class="language-plaintext highlighter-rouge">options = options.replace("hubsize", "directed")</code> will replace the <code class="language-plaintext highlighter-rouge">subMethod</code> of hierarchical of layout from <code class="language-plaintext highlighter-rouge">hubsize</code> to <code class="language-plaintext highlighter-rouge">directed</code>, which works better for our DAG. I think <code class="language-plaintext highlighter-rouge">hubsize</code> might be more suitable for Undireacted Graph.</li>
  <li>The Algorithm from Graphviz is better than vis.js. Our DAG in vis.js sometimes have edges crossing each other. Then you have to manually draw the nodes around to seperate them.</li>
</ol>

<h1 id="examples-for-our-live-data">Examples for our live data</h1>

<h2 id="examle">Examle</h2>

<p>The code is run in our jupyterlab server, which will fetch out the data from our postgres database. Due to the size of the data, I have limited the max_depth and max_width to 10.</p>

<p><img src="/images/pyvis_gdc/sample_subtree.png" alt="sample_subtree" /></p>

<h2 id="code-1">Code</h2>

<p>The following is the code for the live data:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid5</span><span class="p">(</span><span class="n">UUID_NAMESPACE</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
    <span class="n">label_color</span> <span class="o">=</span> <span class="nf">hex</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nf">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">label</span><span class="p">))))</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"#{:f&lt;6}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">label_color</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>


<span class="n">UUID_NAMESPACE_SEED</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="s">"UUID_NAMESPACE_SEED"</span><span class="p">,</span> <span class="s">"f0d2633b-cd8b-45ca-ae86-1d5c759ba0d1"</span><span class="p">)</span>
<span class="n">UUID_NAMESPACE</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">.</span><span class="nc">UUID</span><span class="p">(</span><span class="s">"urn:uuid:{}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">UUID_NAMESPACE_SEED</span><span class="p">),</span> <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw_subtree</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="nf">float</span><span class="p">(</span><span class="s">'inf'</span><span class="p">),</span> <span class="n">show_buttons</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">got_net</span> <span class="o">=</span> <span class="nc">Network</span><span class="p">(</span><span class="n">notebook</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cdn_resources</span><span class="o">=</span><span class="s">'in_line'</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s">'1500px'</span><span class="p">)</span>

    <span class="n">edge_pointer</span> <span class="o">=</span> <span class="s">'in'</span>

    <span class="k">with</span> <span class="n">g</span><span class="p">.</span><span class="nf">session_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="nf">nodes</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>

        <span class="n">marked</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">([(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>


        <span class="n">marked</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">got_net</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span>
            <span class="n">root</span><span class="p">.</span><span class="n">node_id</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="n">root</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> 
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">root</span><span class="p">.</span><span class="n">label</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">root</span><span class="p">.</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="nf">items</span><span class="p">()),</span> 
            <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="nf">get_color</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">label</span><span class="p">)</span>
        <span class="p">)</span>


        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">current</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>


            <span class="k">if</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">edges</span> <span class="o">=</span> <span class="n">current</span><span class="p">.</span><span class="n">edges_out</span> <span class="k">if</span> <span class="n">edge_pointer</span> <span class="o">==</span> <span class="s">"out"</span> <span class="k">else</span> <span class="n">current</span><span class="p">.</span><span class="n">edges_in</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

                <span class="n">n</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">dst</span> <span class="k">if</span> <span class="n">edge_pointer</span> <span class="o">==</span> <span class="s">"out"</span> <span class="k">else</span> <span class="n">edge</span><span class="p">.</span><span class="n">src</span>

                <span class="k">if</span> <span class="n">n</span><span class="p">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">marked</span><span class="p">:</span>
                    <span class="n">queue</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">marked</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">node_id</span><span class="p">)</span>
                    <span class="n">got_net</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span>
                        <span class="n">n</span><span class="p">.</span><span class="n">node_id</span><span class="p">,</span> 
                        <span class="n">label</span><span class="o">=</span><span class="n">n</span><span class="p">.</span><span class="n">label</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">label</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">n</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="nf">items</span><span class="p">()),</span> 
                        <span class="n">level</span><span class="o">=</span><span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">color</span><span class="o">=</span><span class="nf">get_color</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="p">)</span>

                    
                <span class="n">got_net</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">node_id</span><span class="p">,</span> <span class="n">edge</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">node_id</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_width</span><span class="p">:</span>
                    <span class="k">break</span>



    <span class="n">neighbor_map</span> <span class="o">=</span> <span class="n">got_net</span><span class="p">.</span><span class="nf">get_adj_list</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">show_buttons</span><span class="p">:</span>
        <span class="n">got_net</span><span class="p">.</span><span class="nf">show_buttons</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">got_net</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="s">"gameofthrones.html"</span><span class="p">)</span> 
    </code></pre></figure>

<p>The thing to notice about this code is that, to get good hierarchical layout, I rewrte the bsf method in our <a href="https://github.com/NCI-GDC/psqlgraph">psqlgraph</a> repo and set the level property for each node. This was before I figure out the hierarchical sortMethod property. But I kept this implementation so I can set the max_width for my graph.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2023/04/17/analyze-deep-sequence-NGS-data/">
            How to use ReCo to get gRNA read counts from fastq data
            <small>17 Apr 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2023/04/15/use-nmr-data-to-solve-structures/">
            How to use NMR to solve 3D molecule structures
            <small>15 Apr 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2023/04/09/nmrglue/">
            nmrglue
            <small>09 Apr 2023</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
